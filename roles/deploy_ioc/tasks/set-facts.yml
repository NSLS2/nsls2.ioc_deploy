---

- name: Load role defaults into namespace for per-IOC reset
  ansible.builtin.include_vars:
    file: defaults/main.yml
    name: _deploy_ioc_defaults

# Reset all default variables via set_fact to clear any values that persisted
# from a prior loop iteration (set_fact has higher precedence than include_vars,
# so a plain include_vars reload cannot override stale set_fact values).
# deploy_ioc_default_env is excluded because it contains {{ ioc.type }} which
# is not yet defined at this point; it is never set via set_fact elsewhere so
# it does not suffer from cross-iteration leakage.
- name: Reset default variables to prevent set_fact leakage across loop iterations
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ item.value }}" # noqa: var-naming[no-jinja]
  loop: "{{ _deploy_ioc_defaults | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: item.key != 'deploy_ioc_default_env'

- name: Make sure IOC with given name is configured on host
  ansible.builtin.fail:
    msg: "IOC with name {{ deploy_ioc_ioc_name }} is not configured on host"
  when: deploy_ioc_ioc_name not in deploy_ioc_full_ioc_list

- name: Set IOC configuration to variable
  ansible.builtin.set_fact:
    ioc: "{{ host_config[deploy_ioc_ioc_name] }}"

- name: Display read IOC configuration
  ansible.builtin.debug:
    msg: "{{ ioc }}"

- name: Load device type vars into namespace
  ansible.builtin.include_vars:
    file: "vars/{{ ioc.type }}.yml"
    name: _deploy_ioc_type_defaults

# Promote device type vars to set_fact precedence so they override the
# defaults reset above. deploy_ioc_template_root_path is excluded here
# because in many device types it references {{ deploy_ioc_required_module_path }}
# which is not set until after module installation; it is resolved separately
# below.
- name: Apply device type defaults at set_fact precedence
  ansible.builtin.set_fact:
    "{{ item.key }}": "{{ item.value }}" # noqa: var-naming[no-jinja]
  loop: "{{ _deploy_ioc_type_defaults | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  when: item.key != 'deploy_ioc_template_root_path'

- name: Check to make sure IOC can be deployed on this host
  ansible.builtin.fail:
    msg: "EL version {{ ansible_distribution_major_version }} not supported"
  when: >
    deploy_ioc_supported_el_versions is defined
    and ansible_distribution == "RedHat"
    and ansible_distribution_major_version | int not in deploy_ioc_supported_el_versions

- name: Handle any module requirements
  when: deploy_ioc_required_module is defined or ioc.required_module is defined
  block:
    - name: Set required module
      ansible.builtin.set_fact:
        deploy_ioc_required_module: "{{ deploy_ioc_required_module }}"
      when: deploy_ioc_required_module is defined

    - name: Override default required module if specified
      ansible.builtin.set_fact:
        deploy_ioc_required_module: "{{ ioc.required_module }}"
      when: ioc.required_module is defined

    - name: Install any modules that are required for this IOC type
      ansible.builtin.include_role:
        name: nsls2.ioc_deploy.install_module
      vars:
        install_module_name: "{{ deploy_ioc_required_module }}"

    - name: Create variable that stores path to installed required module
      ansible.builtin.set_fact:
        deploy_ioc_required_module_path: "{{ install_module_leaf_module_path }}"

    - name: If specified, override ioc exe with installed module exe
      ansible.builtin.set_fact:
        deploy_ioc_executable: "{{ install_module_leaf_executable }}"
      when: install_module_leaf_executable | default('') != ''

# Now that deploy_ioc_required_module_path is available, resolve
# deploy_ioc_template_root_path from device type vars (which may
# reference it as a Jinja2 template). For device types that set it
# to a static path, this also works correctly.
- name: Resolve device type template root path at set_fact precedence
  ansible.builtin.set_fact:
    deploy_ioc_template_root_path:
      "{{ _deploy_ioc_type_defaults.deploy_ioc_template_root_path }}"
  when: _deploy_ioc_type_defaults.deploy_ioc_template_root_path is defined

- name: Get default environment variables for ioc type
  ansible.builtin.set_fact:
    deploy_ioc_merged_env:
      "{{ deploy_ioc_default_env |
          combine(deploy_ioc_device_specific_env) }}"

- name: Merge any installed module locations into environment
  ansible.builtin.set_fact:
    deploy_ioc_merged_env:
      "{{ deploy_ioc_merged_env
          | combine(install_module_epics_deps, install_module_installed) }}"
  when: deploy_ioc_required_module is defined

- name: Merge in instance specific environment
  ansible.builtin.set_fact:
    deploy_ioc_merged_env:
      "{{ deploy_ioc_merged_env | combine(ioc.environment) }}"
  when: ioc.environment is defined

- name: Show merged environment pre-macro substitution
  ansible.builtin.debug:
    msg: "{{ deploy_ioc_merged_env }}"

- name: Find envvars that use macros
  ansible.builtin.set_fact:
    deploy_ioc_envvars_with_macros: "{{ deploy_ioc_merged_env | dict2items |
                                      selectattr('value', 'search', '\\$\\(') |
                                      map(attribute='key') |
                                      list }}"

- name: Expand all macros in value of {{ item }}
  ansible.builtin.include_tasks: process-env.yml
  with_items: "{{ deploy_ioc_envvars_with_macros }}"

- name: Display merged environment
  ansible.builtin.debug:
    msg: "{{ deploy_ioc_merged_env }}"

- name: Override default IOC exe root path if specified
  ansible.builtin.set_fact:
    deploy_ioc_template_root_path: "{{ ioc.ioc_template_root_path }}"
  when: ioc.ioc_template_root_path is defined

- name: Override default IOC exe name if specified
  ansible.builtin.set_fact:
    deploy_ioc_executable: "{{ ioc.executable }}"
  when: ioc.executable is defined

- name: Get list of substitution files
  ansible.builtin.set_fact:
    substitutions: "{{ ioc.substitutions }}"
  when: ioc.substitutions is defined

- name: Merge any ioc specific dbpf entries
  ansible.builtin.set_fact:
    deploy_ioc_dbpf_list:
      "{{ deploy_ioc_dbpf_list + ioc.dbpf }}"
  when: ioc.dbpf is defined
